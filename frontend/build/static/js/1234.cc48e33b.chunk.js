"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[1234],{1234:(s,e,a)=>{a.r(e),a.d(e,{default:()=>r});var n=a(9379),i=a(2483),t=a(3376),o=a(9859),c=a(5296),l=a(8054),d=a(6723);const r=()=>{const{sessionId:s}=(0,t.g)(),e=(0,t.Zp)(),{socket:a,isConnected:r}=(0,c.Y)(),[m]=(0,o.A)(),u=null===m||void 0===m?void 0:m.user,h=(0,i.useRef)(null),[v,f]=(0,i.useState)(null),[g,p]=(0,i.useState)([]),[x,j]=(0,i.useState)(""),[N,b]=(0,i.useState)(!0),[y,C]=(0,i.useState)(!1),[k,I]=(0,i.useState)(null),[w,A]=(0,i.useState)(null),[S,_]=(0,i.useState)(!1),[E,T]=(0,i.useState)("connecting"),L=(0,i.useCallback)(()=>{var s;null===(s=h.current)||void 0===s||s.scrollIntoView({behavior:"smooth"})},[]),D=(0,i.useCallback)(async()=>{if(s){b(!0),I(null);try{const e=await l.A.get("/api/v1/admin/chat/session/".concat(s));if(e.data.success){const{session:s,messages:a,userInfo:n}=e.data.data;f(s),p(a||[]),A(n||s.userInfo),T("connected")}else I("Failed to load chat session")}catch(t){var e,a;if(console.error("Error loading session:",t),404===(null===(e=t.response)||void 0===e?void 0:e.status))I("Chat session not found");else if(403===(null===(a=t.response)||void 0===a?void 0:a.status))I("Access denied to this chat session");else{var n,i;I((null===(n=t.response)||void 0===n||null===(i=n.data)||void 0===i?void 0:i.message)||"Failed to load chat session")}}finally{b(!1)}}},[s]);(0,i.useEffect)(()=>{!u||1!==u.role&&0!==u.role?e("/Admin/Dashboard"):s?D():I("No session ID provided")},[u,s,D,e]),(0,i.useEffect)(()=>{v&&u&&(async()=>{if(v&&"waiting"===v.status&&(!v.agentId||v.agentId!==u._id))try{await l.A.post("/api/v1/admin/chat/assign/".concat(s),{adminId:u._id}),D()}catch(k){console.error("Error auto-assigning session:",k)}})()},[v,u,s,D]),(0,i.useEffect)(()=>{if(!a||!s)return;a.emit("admin:join_session",{sessionId:s,adminId:u._id});const e=e=>{e.sessionId===s&&(p(s=>[...s,e]),L())},n=e=>{e._id===s&&f(e)},i=e=>{e.sessionId===s&&_(e.isTyping)},t=s=>{console.error("Socket error:",s),I(s.message||"Connection error occurred"),C(!1)},o=s=>{"delivered"===s.status&&console.log("Message delivered:",s.messageId)};return a.on("message:new",e),a.on("session:updated",n),a.on("user:typing",i),a.on("error",t),a.on("message:status",o),()=>{a.off("message:new",e),a.off("session:updated",n),a.off("user:typing",i),a.off("error",t),a.off("message:status",o),a.emit("admin:leave_session",{sessionId:s,adminId:u._id})}},[a,s,u,L]),(0,i.useEffect)(()=>{L()},[g,L]);const F=(0,i.useCallback)(async e=>{if(e.preventDefault(),!x.trim()||y||null===a||void 0===a||!a.connected)return;const n=x.trim();j(""),C(!0);try{a.emit("admin:send_message",{sessionId:s,message:n,adminId:u._id,messageType:"text"}),console.log("Message sent via socket successfully"),setTimeout(()=>{C(!1)},500)}catch(k){console.error("Error sending message:",k),I("Failed to send message"),j(n),C(!1)}},[x,y,s,u,a]),U=(0,i.useCallback)(async()=>{if(window.confirm("Are you sure you want to end this chat session?"))try{(await l.A.post("/api/v1/admin/chat/end/".concat(s),{reason:"ended_by_agent"})).data.success&&f(s=>(0,n.A)((0,n.A)({},s),{},{status:"ended"}))}catch(k){console.error("Error ending session:",k),I("Failed to end session")}},[s]),M=(0,i.useCallback)(function(s){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]||!s)return"https://img.freepik.com/premium-vector/account-icon-user-icon-vector-graphics_292645-552.jpg?w=300";return"string"===typeof s&&s.startsWith("/uploads/userAvatars/")?"".concat("http://localhost:8000/").concat(s):s},[]),R=(0,i.useCallback)(s=>{try{const e=new Date(s);return isNaN(e.getTime())?(console.warn("Invalid date:",s),"Invalid time"):e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}catch(k){return console.error("Error formatting time:",k),"Invalid time"}},[]);return N?(0,d.jsxs)("div",{className:"loading-container",children:[(0,d.jsx)("div",{className:"loading-spinner"}),(0,d.jsx)("p",{className:"loading-text",children:"Loading chat session..."})]}):k?(0,d.jsx)("div",{className:"error-container",children:(0,d.jsxs)("div",{className:"error-content",children:[(0,d.jsx)("i",{className:"fas fa-exclamation-triangle error-icon"}),(0,d.jsx)("h3",{children:"Error Loading Chat"}),(0,d.jsx)("p",{children:k}),(0,d.jsx)("button",{onClick:()=>{I(null),D()},className:"btn btn-secondary mr-2",children:"Retry"}),(0,d.jsx)("button",{onClick:()=>e("/Admin/Chat-List"),className:"btn btn-primary",children:"Back to Chat List"})]})}):(0,d.jsxs)("div",{className:"admin-live-chat-container",children:[(0,d.jsxs)("div",{className:"chat-header",children:[(0,d.jsxs)("div",{className:"chat-header-left",children:[(0,d.jsx)("button",{onClick:()=>e("/Admin/Chat-List"),className:"back-button",children:(0,d.jsx)("i",{className:"fas fa-arrow-left"})}),(0,d.jsxs)("div",{className:"user-avatar",children:[(0,d.jsx)("img",{src:M(null===w||void 0===w?void 0:w.photo,!(null!==w&&void 0!==w&&w.userId)),alt:"User",className:"avatar-img"}),(0,d.jsx)("div",{className:"status-indicator ".concat("active"===(null===v||void 0===v?void 0:v.status)?"online":"offline")})]}),(0,d.jsxs)("div",{className:"user-details",children:[(0,d.jsxs)("h3",{className:"user-name",children:[(null===w||void 0===w?void 0:w.firstName)||(null===w||void 0===w?void 0:w.firstname)||"Guest User"," ",(null===w||void 0===w?void 0:w.lastName)||(null===w||void 0===w?void 0:w.lastname)||""]}),(0,d.jsx)("p",{className:"user-status",children:(null===w||void 0===w?void 0:w.email)||"No email provided"})]})]}),(0,d.jsxs)("div",{className:"chat-header-right",children:[(0,d.jsxs)("div",{className:"connection-status",children:[(0,d.jsx)("i",{className:"fas ".concat(r?"fa-wifi":"fa-wifi-slash")}),(0,d.jsx)("span",{children:r?"Connected":"Disconnected"})]}),(0,d.jsxs)("div",{className:"session-info",children:[(0,d.jsx)("span",{className:"status-badge status-".concat(null===v||void 0===v?void 0:v.status),children:null===v||void 0===v?void 0:v.status}),(0,d.jsxs)("span",{className:"session-id",children:["#",s.slice(-6)]})]}),"ended"!==(null===v||void 0===v?void 0:v.status)&&(0,d.jsxs)("button",{onClick:U,className:"end-session-button",children:[(0,d.jsx)("i",{className:"fas fa-times"}),"End Chat"]})]})]}),(0,d.jsx)("div",{className:"chat-messages",children:(0,d.jsxs)("div",{className:"messages-list",children:[g.map(s=>(0,d.jsx)("div",{className:"message ".concat("agent"===s.senderType?"message-sent":"message-received"),children:(0,d.jsxs)("div",{className:"message-content",children:[(0,d.jsx)("div",{className:"message-text",children:s.message}),(0,d.jsx)("div",{className:"message-time",children:R(s.createdAt||s.timestamp)})]})},s._id)),S&&(0,d.jsx)("div",{className:"message message-received typing-indicator",children:(0,d.jsx)("div",{className:"message-content",children:(0,d.jsxs)("div",{className:"typing-dots",children:[(0,d.jsx)("span",{}),(0,d.jsx)("span",{}),(0,d.jsx)("span",{})]})})}),(0,d.jsx)("div",{ref:h})]})}),(0,d.jsx)("div",{className:"chat-input-container",children:"ended"===(null===v||void 0===v?void 0:v.status)?(0,d.jsxs)("div",{className:"session-ended-notice",children:[(0,d.jsx)("i",{className:"fas fa-info-circle"}),"This chat session has ended"]}):(0,d.jsxs)("form",{onSubmit:F,className:"chat-input-form",children:[(0,d.jsxs)("div",{className:"input-group",children:[(0,d.jsx)("input",{type:"text",value:x,onChange:s=>j(s.target.value),placeholder:"Type your message...",className:"message-input",disabled:y||!r}),(0,d.jsx)("button",{type:"submit",disabled:!x.trim()||y||!r,className:"send-button",children:y?(0,d.jsx)("i",{className:"fas fa-spinner fa-spin"}):(0,d.jsx)("i",{className:"fas fa-paper-plane"})})]}),(0,d.jsxs)("div",{className:"input-status",children:[!r&&(0,d.jsxs)("span",{className:"connection-warning",children:[(0,d.jsx)("i",{className:"fas fa-exclamation-triangle"}),"Connection lost - messages may not be delivered"]}),k&&(0,d.jsxs)("span",{className:"error-warning",children:[(0,d.jsx)("i",{className:"fas fa-exclamation-circle"}),k,(0,d.jsx)("button",{onClick:()=>I(null),className:"error-dismiss",type:"button",children:"\xd7"})]})]})]})})]})}}}]);
//# sourceMappingURL=1234.cc48e33b.chunk.js.map